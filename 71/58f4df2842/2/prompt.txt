Implement the following plan:

# OAuth コールバックを HTTPS (127.0.0.1) + リトライ対応に修正

## Context

現在の実装は `https://localhost:9876` + `generate_simple_self_signed(["localhost"])` を使っているが、ブラウザが自己署名証明書を `CertificateUnknown` で即座に拒否し TLS ハンドシェイクが失敗する。

**原因:** `wait_for_callback()` が1回の `accept` で終了するため、ブラウザが証明書を拒否 → ユーザーが「続行」を選択 → 2回目の接続時にはサーバーが既に終了、となっている。

**修正:**
1. `REDIRECT_URI` を `https://127.0.0.1:9876` に変更
2. 自己署名証明書の SAN を IP アドレス `127.0.0.1` に変更
3. `wait_for_callback()` にリトライループ追加（TLS エラー時は次の接続を待つ）

## 変更ファイル

`src/oauth.rs` のみ。`Cargo.toml` / `src/main.rs` は変更なし。

## `src/oauth.rs` — 変更箇所

### 1. `REDIRECT_URI` (L11)
```rust
// before
const REDIRECT_URI: &str = "https://localhost:9876";
// after
const REDIRECT_URI: &str = "https://127.0.0.1:9876";
```

### 2. `build_tls_config()` (L56-69) — SAN を IP アドレスに変更

`generate_simple_self_signed` は DNS 名前提。`CertificateParams::new("127.0.0.1")` は IP 文字列を自動的に `SanType::IpAddress` に変換する。`KeyPair` は別途生成。

```rust
fn build_tls_config() -> Result<ServerConfig, SlkError> {
    let key_pair = rcgen::KeyPair::generate()
        .map_err(|e| SlkError::from(format!("failed to generate key pair: {}", e)))?;
    let cert = rcgen::CertificateParams::new(vec!["127.0.0.1".to_string()])
        .map_err(|e| SlkError::from(format!("failed to create cert params: {}", e)))?
        .self_signed(&key_pair)
        .map_err(|e| SlkError::from(format!("failed to generate self-signed cert: {}", e)))?;

    let cert_der = cert.der().clone();
    let key_der = PrivateKeyDer::Pkcs8(key_pair.serialize_der().into());

    let config = ServerConfig::builder()
        .with_no_client_auth()
        .with_single_cert(vec![cert_der], key_der)
        .map_err(|e| SlkError::from(format!("failed to build TLS config: {}", e)))?;
    Ok(config)
}
```

import 変更: `use rcgen::generate_simple_self_signed;` を削除（不要になる）。

### 3. `wait_for_callback()` (L71-102) — リトライループ追加

`loop` で `accept` → TLS ハンドシェイク → `read` を繰り返し、成功したら `return`。失敗（証明書拒否等）したら `continue` で次の接続を待つ。

```rust
fn wait_for_callback(tls_config: Arc<ServerConfig>) -> Result<String, SlkError> {
    let listener = TcpListener::bind("127.0.0.1:9876")
        .map_err(|e| SlkError::from(format!("failed to bind port 9876: {}", e)))?;
    eprintln!("Waiting for callback on https://127.0.0.1:9876 ...");

    loop {
        let (tcp_stream, _) = listener
            .accept()
            .map_err(|e| SlkError::from(format!("failed to accept connection: {}", e)))?;
        let tls_conn = rustls::ServerConnection::new(Arc::clone(&tls_config))
            .map_err(|e| SlkError::from(format!("failed to create TLS connection: {}", e)))?;
        let mut stream = rustls::StreamOwned::new(tls_conn, tcp_stream);

        let mut buf = [0u8; 2048];
        let n = match stream.read(&mut buf) {
            Ok(n) if n > 0 => n,
            _ => continue, // TLS失敗 → 次の接続を待つ
        };
        let request = String::from_utf8_lossy(&buf[..n]).to_string();

        // 成功レスポンス返却
        let response_body = "<html><body><h1>Authorization successful!</h1><p>You can close this tab.</p></body></html>";
        let response = format!(
            "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: {}\r\nConnection: close\r\n\r\n{}",
            response_body.len(), response_body
        );
        let _ = stream.write_all(response.as_bytes());
        stream.conn.send_close_notify();
        let _ = stream.conn.write_tls(&mut stream.sock);

        return Ok(request);
    }
}
```

### 4. `run_oauth_flow()` (L175-176) — メッセージ更新

証明書警告について案内を追加:
```rust
eprintln!("Opening browser for authorization...");
eprintln!("If prompted about the certificate, click 'Advanced' and 'Proceed'.");
```

## 検証

```bash
cargo check
cargo test
cargo clippy
cargo run -- login
```


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /home/kanta/.claude/projects/-home-kanta-src-otomarukanta-slk/c191ae39-e839-4125-b85f-e54be3f4bfea.jsonl

---

## Context

- Current git status: On branch main
Your branch is ahead of 'origin/main' by 1 commit.
  (use "git push" to publish your local commits)

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   Cargo.lock
	modified:   Cargo.toml
	modified:   src/oauth.rs

no changes added to commit (use "git add" and/or "git commit -a")
- Current git diff (staged and unstaged changes): diff --git a/Cargo.lock b/Cargo.lock
index ded487e..3ea1357 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -2,6 +2,565 @@
 # It is not intended for manual editing.
 version = 4
 
+[[package]]
+name = "asn1-rs"
+version = "0.7.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "56624a96882bb8c26d61312ae18cb45868e5a9992ea73c58e45c3101e56a1e60"
+dependencies = [
+ "asn1-rs-derive",
+ "asn1-rs-impl",
+ "displaydoc",
+ "nom",
+ "num-traits",
+ "rusticata-macros",
+ "thiserror",
+ "time",
+]
+
+[[package]]
+name = "asn1-rs-derive"
+version = "0.6.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "3109e49b1e4909e9db6515a30c633684d68cdeaa252f215214cb4fa1a5bfee2c"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn",
+ "synstructure",
+]
+
+[[package]]
+name = "asn1-rs-impl"
+version = "0.2.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7b18050c2cd6fe86c3a76584ef5e0baf286d038cda203eb6223df2cc413565f7"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn",
+]
+
+[[package]]
+name = "autocfg"
+version = "1.5.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "c08606f8c3cbf4ce6ec8e28fb0014a2c086708fe954eaa885384a6165172e7e8"
+
+[[package]]
+name = "base64"
+version = "0.22.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "72b3254f16251a8381aa12e40e3c4d2f0199f8c6508fbecb9d91f575e0fbb8c6"
+
+[[package]]
+name = "cc"
+version = "1.2.55"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "47b26a0954ae34af09b50f0de26458fa95369a0d478d8236d3f93082b219bd29"
+dependencies = [
+ "find-msvc-tools",
+ "shlex",
+]
+
+[[package]]
+name = "cfg-if"
+version = "1.0.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9330f8b2ff13f34540b44e946ef35111825727b38d33286ef986142615121801"
+
+[[package]]
+name = "data-encoding"
+version = "2.10.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d7a1e2f27636f116493b8b860f5546edb47c8d8f8ea73e1d2a20be88e28d1fea"
+
+[[package]]
+name = "der-parser"
+version = "10.0.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "07da5016415d5a3c4dd39b11ed26f915f52fc4e0dc197d87908bc916e51bc1a6"
+dependencies = [
+ "asn1-rs",
+ "displaydoc",
+ "nom",
+ "num-bigint",
+ "num-traits",
+ "rusticata-macros",
+]
+
+[[package]]
+name = "deranged"
+version = "0.5.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "cc3dc5ad92c2e2d1c193bbbbdf2ea477cb81331de4f3103f267ca18368b988c4"
+dependencies = [
+ "powerfmt",
+]
+
+[[package]]
+name = "displaydoc"
+version = "0.2.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "97369cbbc041bc366949bc74d34658d6cda5621039731c6310521892a3a20ae0"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn",
+]
+
+[[package]]
+name = "find-msvc-tools"
+version = "0.1.9"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "5baebc0774151f905a1a2cc41989300b1e6fbb29aff0ceffa1064fdd3088d582"
+
+[[package]]
+name = "getrandom"
+version = "0.2.17"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ff2abc00be7fca6ebc474524697ae276ad847ad0a6b3faa4bcb027e9a4614ad0"
+dependencies = [
+ "cfg-if",
+ "libc",
+ "wasi",
+]
+
+[[package]]
+name = "itoa"
+version = "1.0.17"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "92ecc6618181def0457392ccd0ee51198e065e016d1d527a7ac1b6dc7c1f09d2"
+
+[[package]]
+name = "lazy_static"
+version = "1.5.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "bbd2bcb4c963f2ddae06a2efc7e9f3591312473c50c6685e1f298068316e66fe"
+
+[[package]]
+name = "libc"
+version = "0.2.181"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "459427e2af2b9c839b132acb702a1c654d95e10f8c326bfc2ad11310e458b1c5"
+
+[[package]]
+name = "log"
+version = "0.4.29"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "5e5032e24019045c762d3c0f28f5b6b8bbf38563a65908389bf7978758920897"
+
+[[package]]
+name = "memchr"
+version = "2.8.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "f8ca58f447f06ed17d5fc4043ce1b10dd205e060fb3ce5b979b8ed8e59ff3f79"
+
+[[package]]
+name = "minimal-lexical"
+version = "0.2.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "68354c5c6bd36d73ff3feceb05efa59b6acb7626617f4962be322a825e61f79a"
+
+[[package]]
+name = "nom"
+version = "7.1.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d273983c5a657a70a3e8f2a01329822f3b8c8172b73826411a55751e404a0a4a"
+dependencies = [
+ "memchr",
+ "minimal-lexical",
+]
+
+[[package]]
+name = "num-bigint"
+version = "0.4.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "a5e44f723f1133c9deac646763579fdb3ac745e418f2a7af9cd0c431da1f20b9"
+dependencies = [
+ "num-integer",
+ "num-traits",
+]
+
+[[package]]
+name = "num-conv"
+version = "0.2.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "cf97ec579c3c42f953ef76dbf8d55ac91fb219dde70e49aa4a6b7d74e9919050"
+
+[[package]]
+name = "num-integer"
+version = "0.1.46"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7969661fd2958a5cb096e56c8e1ad0444ac2bbcd0061bd28660485a44879858f"
+dependencies = [
+ "num-traits",
+]
+
+[[package]]
+name = "num-traits"
+version = "0.2.19"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "071dfc062690e90b734c0b2273ce72ad0ffa95f0c74596bc250dcfd960262841"
+dependencies = [
+ "autocfg",
+]
+
+[[package]]
+name = "oid-registry"
+version = "0.8.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "12f40cff3dde1b6087cc5d5f5d4d65712f34016a03ed60e9c08dcc392736b5b7"
+dependencies = [
+ "asn1-rs",
+]
+
+[[package]]
+name = "once_cell"
+version = "1.21.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "42f5e15c9953c5e4ccceeb2e7382a716482c34515315f7b03532b8b4e8393d2d"
+
+[[package]]
+name = "pem"
+version = "3.0.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "1d30c53c26bc5b31a98cd02d20f25a7c8567146caf63ed593a9d87b2775291be"
+dependencies = [
+ "base64",
+ "serde_core",
+]
+
+[[package]]
+name = "powerfmt"
+version = "0.2.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "439ee305def115ba05938db6eb1644ff94165c5ab5e9420d1c1bcedbba909391"
+
+[[package]]
+name = "proc-macro2"
+version = "1.0.106"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "8fd00f0bb2e90d81d1044c2b32617f68fcb9fa3bb7640c23e9c748e53fb30934"
+dependencies = [
+ "unicode-ident",
+]
+
+[[package]]
+name = "quote"
+version = "1.0.44"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "21b2ebcf727b7760c461f091f9f0f539b77b8e87f2fd88131e7f1b433b3cece4"
+dependencies = [
+ "proc-macro2",
+]
+
+[[package]]
+name = "rcgen"
+version = "0.14.7"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "10b99e0098aa4082912d4c649628623db6aba77335e4f4569ff5083a6448b32e"
+dependencies = [
+ "pem",
+ "ring",
+ "rustls-pki-types",
+ "time",
+ "x509-parser",
+ "yasna",
+]
+
+[[package]]
+name = "ring"
+version = "0.17.14"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "a4689e6c2294d81e88dc6261c768b63bc4fcdb852be6d1352498b114f61383b7"
+dependencies = [
+ "cc",
+ "cfg-if",
+ "getrandom",
+ "libc",
+ "untrusted",
+ "windows-sys",
+]
+
+[[package]]
+name = "rusticata-macros"
+version = "4.1.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "faf0c4a6ece9950b9abdb62b1cfcf2a68b3b67a10ba445b3bb85be2a293d0632"
+dependencies = [
+ "nom",
+]
+
+[[package]]
+name = "rustls"
+version = "0.23.36"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "c665f33d38cea657d9614f766881e4d510e0eda4239891eea56b4cadcf01801b"
+dependencies = [
+ "log",
+ "once_cell",
+ "ring",
+ "rustls-pki-types",
+ "rustls-webpki",
+ "subtle",
+ "zeroize",
+]
+
+[[package]]
+name = "rustls-pki-types"
+version = "1.14.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "be040f8b0a225e40375822a563fa9524378b9d63112f53e19ffff34df5d33fdd"
+dependencies = [
+ "zeroize",
+]
+
+[[package]]
+name = "rustls-webpki"
+version = "0.103.9"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d7df23109aa6c1567d1c575b9952556388da57401e4ace1d15f79eedad0d8f53"
+dependencies = [
+ "ring",
+ "rustls-pki-types",
+ "untrusted",
+]
+
+[[package]]
+name = "serde_core"
+version = "1.0.228"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "41d385c7d4ca58e59fc732af25c3983b67ac852c1a25000afe1175de458b67ad"
+dependencies = [
+ "serde_derive",
+]
+
+[[package]]
+name = "serde_derive"
+version = "1.0.228"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d540f220d3187173da220f885ab66608367b6574e925011a9353e4badda91d79"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn",
+]
+
+[[package]]
+name = "shlex"
+version = "1.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0fda2ff0d084019ba4d7c6f371c95d8fd75ce3524c3cb8fb653a3023f6323e64"
+
 [[package]]
 name = "slk"
 version = "0.1.0"
+dependencies = [
+ "rcgen",
+ "rustls",
+ "rustls-pki-types",
+]
+
+[[package]]
+name = "subtle"
+version = "2.6.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "13c2bddecc57b384dee18652358fb23172facb8a2c51ccc10d74c157bdea3292"
+
+[[package]]
+name = "syn"
+version = "2.0.114"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d4d107df263a3013ef9b1879b0df87d706ff80f65a86ea879bd9c31f9b307c2a"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "unicode-ident",
+]
+
+[[package]]
+name = "synstructure"
+version = "0.13.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "728a70f3dbaf5bab7f0c4b1ac8d7ae5ea60a4b5549c8a5914361c99147a709d2"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn",
+]
+
+[[package]]
+name = "thiserror"
+version = "2.0.18"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "4288b5bcbc7920c07a1149a35cf9590a2aa808e0bc1eafaade0b80947865fbc4"
+dependencies = [
+ "thiserror-impl",
+]
+
+[[package]]
+name = "thiserror-impl"
+version = "2.0.18"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ebc4ee7f67670e9b64d05fa4253e753e016c6c95ff35b89b7941d6b856dec1d5"
+dependencies = [
+ "proc-macro2",
+ "quote",
+ "syn",
+]
+
+[[package]]
+name = "time"
+version = "0.3.47"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "743bd48c283afc0388f9b8827b976905fb217ad9e647fae3a379a9283c4def2c"
+dependencies = [
+ "deranged",
+ "itoa",
+ "num-conv",
+ "powerfmt",
+ "serde_core",
+ "time-core",
+ "time-macros",
+]
+
+[[package]]
+name = "time-core"
+version = "0.1.8"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "7694e1cfe791f8d31026952abf09c69ca6f6fa4e1a1229e18988f06a04a12dca"
+
+[[package]]
+name = "time-macros"
+version = "0.2.27"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "2e70e4c5a0e0a8a4823ad65dfe1a6930e4f4d756dcd9dd7939022b5e8c501215"
+dependencies = [
+ "num-conv",
+ "time-core",
+]
+
+[[package]]
+name = "unicode-ident"
+version = "1.0.23"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "537dd038a89878be9b64dd4bd1b260315c1bb94f4d784956b81e27a088d9a09e"
+
+[[package]]
+name = "untrusted"
+version = "0.9.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "8ecb6da28b8a351d773b68d5825ac39017e680750f980f3a1a85cd8dd28a47c1"
+
+[[package]]
+name = "wasi"
+version = "0.11.1+wasi-snapshot-preview1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "ccf3ec651a847eb01de73ccad15eb7d99f80485de043efb2f370cd654f4ea44b"
+
+[[package]]
+name = "windows-sys"
+version = "0.52.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "282be5f36a8ce781fad8c8ae18fa3f9beff57ec1b52cb3de0789201425d9a33d"
+dependencies = [
+ "windows-targets",
+]
+
+[[package]]
+name = "windows-targets"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "9b724f72796e036ab90c1021d4780d4d3d648aca59e491e6b98e725b84e99973"
+dependencies = [
+ "windows_aarch64_gnullvm",
+ "windows_aarch64_msvc",
+ "windows_i686_gnu",
+ "windows_i686_gnullvm",
+ "windows_i686_msvc",
+ "windows_x86_64_gnu",
+ "windows_x86_64_gnullvm",
+ "windows_x86_64_msvc",
+]
+
+[[package]]
+name = "windows_aarch64_gnullvm"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "32a4622180e7a0ec044bb555404c800bc9fd9ec262ec147edd5989ccd0c02cd3"
+
+[[package]]
+name = "windows_aarch64_msvc"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "09ec2a7bb152e2252b53fa7803150007879548bc709c039df7627cabbd05d469"
+
+[[package]]
+name = "windows_i686_gnu"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "8e9b5ad5ab802e97eb8e295ac6720e509ee4c243f69d781394014ebfe8bbfa0b"
+
+[[package]]
+name = "windows_i686_gnullvm"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "0eee52d38c090b3caa76c563b86c3a4bd71ef1a819287c19d586d7334ae8ed66"
+
+[[package]]
+name = "windows_i686_msvc"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "240948bc05c5e7c6dabba28bf89d89ffce3e303022809e73deaefe4f6ec56c66"
+
+[[package]]
+name = "windows_x86_64_gnu"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "147a5c80aabfbf0c7d901cb5895d1de30ef2907eb21fbbab29ca94c5b08b1a78"
+
+[[package]]
+name = "windows_x86_64_gnullvm"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "24d5b23dc417412679681396f2b49f3de8c1473deb516bd34410872eff51ed0d"
+
+[[package]]
+name = "windows_x86_64_msvc"
+version = "0.52.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "589f6da84c646204747d1270a2a5661ea66ed1cced2631d546fdfb155959f9ec"
+
+[[package]]
+name = "x509-parser"
+version = "0.18.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "d43b0f71ce057da06bc0851b23ee24f3f86190b07203dd8f567d0b706a185202"
+dependencies = [
+ "asn1-rs",
+ "data-encoding",
+ "der-parser",
+ "lazy_static",
+ "nom",
+ "oid-registry",
+ "ring",
+ "rusticata-macros",
+ "thiserror",
+ "time",
+]
+
+[[package]]
+name = "yasna"
+version = "0.5.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "e17bb3549cc1321ae1296b9cdc2698e2b6cb1992adfa19a8c72e5b7a738f44cd"
+dependencies = [
+ "time",
+]
+
+[[package]]
+name = "zeroize"
+version = "1.8.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+checksum = "b97154e67e32c85465826e8bcc1c59429aaaf107c1e4a9e53c8d8ccd5eff88d0"
diff --git a/Cargo.toml b/Cargo.toml
index 00a809c..b862f16 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -6,3 +6,6 @@ description = "A CLI tool to read Slack threads"
 license = "MIT"
 
 [dependencies]
+rcgen = "0.14"
+rustls = { version = "0.23", default-features = false, features = ["ring", "logging", "std", "tls12"] }
+rustls-pki-types = "1"
diff --git a/src/oauth.rs b/src/oauth.rs
index fbdcaae..fcdf94a 100644
--- a/src/oauth.rs
+++ b/src/oauth.rs
@@ -1,25 +1,106 @@
 use crate::error::SlkError;
+use std::io::{Read, Write};
+use std::net::TcpListener;
 use std::process::Command;
+use std::sync::Arc;
 
-const REDIRECT_URI: &str = "https://localhost:9876";
+use rustls::pki_types::PrivateKeyDer;
+use rustls::ServerConfig;
 
-fn extract_code_from_url(url: &str) -> Result<String, SlkError> {
-    let query = url
+const REDIRECT_URI: &str = "https://127.0.0.1:9876";
+
+fn generate_state() -> Result<String, SlkError> {
+    let mut buf = [0u8; 16];
+    let mut f = std::fs::File::open("/dev/urandom")
+        .map_err(|e| SlkError::from(format!("failed to open /dev/urandom: {}", e)))?;
+    f.read_exact(&mut buf)
+        .map_err(|e| SlkError::from(format!("failed to read /dev/urandom: {}", e)))?;
+    Ok(buf.iter().map(|b| format!("{:02x}", b)).collect())
+}
+
+fn extract_callback_params(request: &str) -> Result<(String, String), SlkError> {
+    let path = request
+        .split_whitespace()
+        .nth(1)
+        .ok_or(SlkError::from("invalid HTTP request"))?;
+
+    let query = path
         .split('?')
         .nth(1)
-        .ok_or(SlkError::from("no query string in callback URL"))?;
+        .ok_or(SlkError::from("no query string in callback"))?;
+
+    let mut code = None;
+    let mut state = None;
 
     for param in query.split('&') {
         if let Some(value) = param.strip_prefix("code=") {
             if !value.is_empty() {
-                return Ok(value.to_string());
+                code = Some(value.to_string());
             }
+        } else if let Some(value) = param.strip_prefix("state=")
+            && !value.is_empty()
+        {
+            state = Some(value.to_string());
         }
     }
 
-    Err(SlkError::from(
+    let code = code.ok_or(SlkError::from(
         "no 'code' parameter in callback. Authorization may have been denied.",
-    ))
+    ))?;
+    let state = state.ok_or(SlkError::from("no 'state' parameter in callback"))?;
+
+    Ok((code, state))
+}
+
+fn build_tls_config() -> Result<ServerConfig, SlkError> {
+    let key_pair = rcgen::KeyPair::generate()
+        .map_err(|e| SlkError::from(format!("failed to generate key pair: {}", e)))?;
+    let cert = rcgen::CertificateParams::new(vec!["127.0.0.1".to_string()])
+        .map_err(|e| SlkError::from(format!("failed to create cert params: {}", e)))?
+        .self_signed(&key_pair)
+        .map_err(|e| SlkError::from(format!("failed to generate self-signed cert: {}", e)))?;
+
+    let cert_der = cert.der().clone();
+    let key_der = PrivateKeyDer::Pkcs8(key_pair.serialize_der().into());
+
+    let config = ServerConfig::builder()
+        .with_no_client_auth()
+        .with_single_cert(vec![cert_der], key_der)
+        .map_err(|e| SlkError::from(format!("failed to build TLS config: {}", e)))?;
+    Ok(config)
+}
+
+fn wait_for_callback(tls_config: Arc<ServerConfig>) -> Result<String, SlkError> {
+    let listener = TcpListener::bind("127.0.0.1:9876")
+        .map_err(|e| SlkError::from(format!("failed to bind port 9876: {}", e)))?;
+    eprintln!("Waiting for callback on https://127.0.0.1:9876 ...");
+
+    loop {
+        let (tcp_stream, _) = listener
+            .accept()
+            .map_err(|e| SlkError::from(format!("failed to accept connection: {}", e)))?;
+        let tls_conn = rustls::ServerConnection::new(Arc::clone(&tls_config))
+            .map_err(|e| SlkError::from(format!("failed to create TLS connection: {}", e)))?;
+        let mut stream = rustls::StreamOwned::new(tls_conn, tcp_stream);
+
+        let mut buf = [0u8; 2048];
+        let n = match stream.read(&mut buf) {
+            Ok(n) if n > 0 => n,
+            _ => continue,
+        };
+        let request = String::from_utf8_lossy(&buf[..n]).to_string();
+
+        let response_body = "<html><body><h1>Authorization successful!</h1><p>You can close this tab.</p></body></html>";
+        let response = format!(
+            "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: {}\r\nConnection: close\r\n\r\n{}",
+            response_body.len(), response_body
+        );
+        let _ = stream.write_all(response.as_bytes());
+        stream.conn.send_close_notify();
+        let _ = stream.conn.write_tls(&mut stream.sock);
+
+        return Ok(request);
+    }
 }
 
 fn exchange_code(
@@ -83,28 +164,30 @@ fn exchange_code(
 }
 
 pub fn run_oauth_flow(client_id: &str, client_secret: &str) -> Result<String, SlkError> {
+    let state = generate_state()?;
+    let tls_config = Arc::new(build_tls_config()?);
+
     let auth_url = format!(
-        "https://slack.com/oauth/v2/authorize?client_id={}&user_scope=channels:history,groups:history,users:read&redirect_uri={}",
+        "https://slack.com/oauth/v2/authorize?client_id={}&user_scope=channels:history,groups:history,users:read&redirect_uri={}&state={}",
         client_id,
-        REDIRECT_URI.replace(':', "%3A").replace('/', "%2F")
+        REDIRECT_URI.replace(':', "%3A").replace('/', "%2F"),
+        state
     );
 
-    eprintln!("Open this URL in your browser:\n  {}", auth_url);
+    eprintln!("Opening browser for authorization...");
+    eprintln!("If prompted about the certificate, click 'Advanced' and 'Proceed'.");
+    eprintln!("If the browser doesn't open, visit:\n  {}", auth_url);
     let _ = Command::new("xdg-open").arg(&auth_url).spawn();
 
-    eprintln!("\nAfter authorization, your browser will show a connection error.");
-    eprintln!("Copy the URL from the address bar and paste it here:");
+    let request = wait_for_callback(tls_config)?;
+    let (code, callback_state) = extract_callback_params(&request)?;
 
-    let mut input = String::new();
-    std::io::stdin()
-        .read_line(&mut input)
-        .map_err(|e| SlkError::from(format!("failed to read input: {}", e)))?;
-    let input = input.trim();
-    if input.is_empty() {
-        return Err(SlkError::from("no URL provided"));
+    if callback_state != state {
+        return Err(SlkError::from(
+            "state mismatch: possible CSRF attack. Please try again.",
+        ));
     }
 
-    let code = extract_code_from_url(input)?;
     exchange_code(client_id, client_secret, &code)
 }
 
@@ -113,26 +196,57 @@ mod tests {
     use super::*;
 
     #[test]
-    fn test_extract_code_valid() {
-        let url = "https://localhost:9876?code=abc123def";
-        assert_eq!(extract_code_from_url(url).unwrap(), "abc123def");
+    fn test_extract_callback_params_valid() {
+        let request = "GET /?code=abc123&state=deadbeef HTTP/1.1\r\nHost: localhost\r\n";
+        let (code, state) = extract_callback_params(request).unwrap();
+        assert_eq!(code, "abc123");
+        assert_eq!(state, "deadbeef");
+    }
+
+    #[test]
+    fn test_extract_callback_params_reversed_order() {
+        let request = "GET /?state=mystate&code=mycode HTTP/1.1\r\n";
+        let (code, state) = extract_callback_params(request).unwrap();
+        assert_eq!(code, "mycode");
+        assert_eq!(state, "mystate");
+    }
+
+    #[test]
+    fn test_extract_callback_params_missing_code() {
+        let request = "GET /?state=abc HTTP/1.1\r\n";
+        let err = extract_callback_params(request).unwrap_err();
+        assert!(err.message.contains("code"));
+    }
+
+    #[test]
+    fn test_extract_callback_params_missing_state() {
+        let request = "GET /?code=abc HTTP/1.1\r\n";
+        let err = extract_callback_params(request).unwrap_err();
+        assert!(err.message.contains("state"));
+    }
+
+    #[test]
+    fn test_extract_callback_params_no_query() {
+        let request = "GET / HTTP/1.1\r\n";
+        assert!(extract_callback_params(request).is_err());
     }
 
     #[test]
-    fn test_extract_code_multiple_params() {
-        let url = "https://localhost:9876?state=xyz&code=mycode456";
-        assert_eq!(extract_code_from_url(url).unwrap(), "mycode456");
+    fn test_extract_callback_params_empty_request() {
+        assert!(extract_callback_params("").is_err());
     }
 
     #[test]
-    fn test_extract_code_missing() {
-        let url = "https://localhost:9876?error=access_denied";
-        assert!(extract_code_from_url(url).is_err());
+    fn test_generate_state_length_and_hex() {
+        let state = generate_state().unwrap();
+        assert_eq!(state.len(), 32);
+        assert!(state.chars().all(|c| c.is_ascii_hexdigit()));
     }
 
     #[test]
-    fn test_extract_code_no_query() {
-        let url = "https://localhost:9876";
-        assert!(extract_code_from_url(url).is_err());
+    fn test_generate_state_unique() {
+        let s1 = generate_state().unwrap();
+        let s2 = generate_state().unwrap();
+        assert_ne!(s1, s2);
     }
 }
- Current branch: main
- Recent commits: bfa226a feat: add OAuth login flow with manual URL paste method Entire-Checkpoint: a62ea2ed5972
da37dd2 chore: add entire tool configuration and claude code hooks Entire-Checkpoint: a96020e1cce9
3d51ab1 feat: resolve user names via users.info API with error handling Entire-Checkpoint: 954e1bef0b32
360c735 feat: add timestamp display to slack messages Entire-Checkpoint: fb12e6658184
af6c4ef first commit

## Your task

変更内容を分析し、3つのコミットメッセージ候補を生成してユーザーに選択させます。

1. Analyze the diff content to understand the nature and purpose of the changes
2. Generate 3 commit message candidates based on the changes
   - Each candidate should be concise, clear, and capture the essence of the changes
   - Prefer Conventional Commits format (feat:, fix:, docs:, refactor:, etc.)
3. Select the most appropriate commit message from the 3 candidates and explain the reasoning for your choice
4. Stage changes if necessary using git add
5. Execute git commit using the selected commit message

## Constraint

- Claude co-authorshipフッターは不要
- 1行で簡潔
- メッセージは簡単な英語